<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ASR Labeling Platform</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
      background: #f9f9f9;
    }
    label {
      display: block;
      margin: 1rem 0 0.5rem;
    }
    input, textarea, button {
      padding: 0.5rem;
      width: 100%;
      max-width: 500px;
      margin-bottom: 1rem;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button[disabled] {
      background-color: #aaa;
    }
    audio {
      display: block;
      margin: 1rem 0;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>ASR Transcription Interface</h1>

  <label for="agentName">üë§ Agent Name:</label>
  <input type="text" id="agentName" placeholder="Enter your name" />

  <button id="getTaskBtn" onclick="fetchTask()">üéß Get Task</button>

  <div id="taskSection" class="hidden">
    <h2>üìù Transcription Task</h2>
    <p><strong>Filename:</strong> <span id="filename"></span></p>
    <audio id="audioPlayer" controls></audio>

    <label for="transcription">‚úçÔ∏è Transcription:</label>
    <textarea id="transcription" rows="6" placeholder="Type the transcription here..."></textarea>

    <button onclick="submitTranscription()">‚úÖ Submit Transcription</button>
  </div>

  <script>
    const GET_TASK_ENDPOINT = "https://myn8n-rtofljaal.liara.run/webhook/voice-transcription-interface";
    const ASSIGN_ENDPOINT = "https://myn8n-rtofljaal.liara.run/webhook/assign-task";
    const SUBMIT_ENDPOINT = "https://myn8n-rtofljaal.liara.run/webhook/send-transcription";

    let currentFile = null;

    function extractDriveFileId(url) {
      const match = url.match(/\/d\/(.*?)\//);
      return match ? match[1] : null;
    }

    async function fetchTask() {
      const agent = document.getElementById("agentName").value.trim();
      if (!agent) {
        alert("‚õî Please enter your name first.");
        return;
      }

      const btn = document.getElementById("getTaskBtn");
      btn.disabled = true;
      btn.textContent = "‚è≥ Loading...";

      try {
        const res = await fetch(GET_TASK_ENDPOINT);
        const data = await res.json();

        if (!data || data.length === 0) {
          alert("‚úÖ No pending tasks. You're all caught up!");
          btn.textContent = "üéß Get Task";
          btn.disabled = false;
          return;
        }

        const file = data[0];
        currentFile = file;

        const fileId = extractDriveFileId(file.url);
        const directUrl = fileId
          ? `https://drive.google.com/uc?export=download&id=${fileId}`
          : file.url;

        document.getElementById("filename").textContent = file.Filename;
        document.getElementById("audioPlayer").src = directUrl;
        document.getElementById("transcription").value = "";
        document.getElementById("taskSection").classList.remove("hidden");

        // Assign task
        await fetch(ASSIGN_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            fileId: file["File ID"],
            agent
          })
        });

      } catch (err) {
        console.error("Error fetching task:", err);
        alert("‚ùå Failed to fetch task. Try again.");
      } finally {
        btn.textContent = "üéß Get Task";
        btn.disabled = false;
      }
    }

    async function submitTranscription() {
      const agent = document.getElementById("agentName").value.trim();
      const transcription = document.getElementById("transcription").value.trim();

      if (!agent || !transcription || !currentFile) {
        alert("‚õî Please complete all fields before submitting.");
        return;
      }

      const timestamp = new Date().toISOString();

      const res = await fetch(SUBMIT_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          fileId: currentFile["File ID"],
          transcription,
          agent,
          timestamp
        })
      });

      if (res.ok) {
        alert("‚úÖ Transcription submitted!");
        document.getElementById("taskSection").classList.add("hidden");
        fetchTask(); // Automatically fetch next
      } else {
        alert("‚ùå Submission failed. Try again.");
      }
    }
  </script>
</body>
</html>
